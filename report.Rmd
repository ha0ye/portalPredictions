---
title: "Report - Latest Rodent Data"
---
Here are the most recent actual data (blue) compared to the forecast performed 
right before data collection (black, with error bars)

```{r, echo = FALSE, message = FALSE, warning = FALSE}
source("tools/forecast_tools.R")

# get most recent rodent data
rodents <- portalr::abundance("repo", shape = "flat", level = "treatment", 
             length = "longterm")
most_recent_period <- max(rodents$period)
observed <- dplyr::filter(rodents,  
              period == most_recent_period, treatment == "control")

# get new moon number associated with this period
url_base <- "https://raw.githubusercontent.com/weecology/PortalData/master/"
url_suffix <- "Rodents/moon_dates.csv"
nm_url <- paste(url_base, url_suffix, sep = "")
nm_table <- read.csv(text = RCurl::getURL(nm_url))
nm_table$censusdate <- as.Date(nm_table$censusdate)
moon_code <- dplyr::filter(nm_table, period == most_recent_period) %>% 
             dplyr::select(newmoonnumber) %>% 
             as.integer()
most_recent_date <- dplyr::filter(nm_table, period == most_recent_period) %>%
                    dplyr::pull(censusdate)

# get most recent forecast prior to data collection
file_names <- list.files(path = "./predictions", pattern = "*forecasts.csv")
files <- data.frame(names = file_names)
files$filedates <- as.Date(substr(files$names, 1, 10), format = "%Y-%m-%d")
latest_forecast <- dplyr::filter(files,filedates<most_recent_date) %>% 
                   tail(1)

file_name <- paste("predictions/", latest_forecast$names, sep="")
data <- read.csv(file_name, na.strings = "")

ensemble <- dplyr::filter(data, level == "Controls", model == "Ensemble", 
              newmoonnumber == moon_code)
ensemble$date <- as.Date(as.character(ensemble$date))
sp_predictions <- get_sp_predicts(ensemble, "Controls", lead_time = 1)


joined_data <- dplyr::left_join(sp_predictions, observed, by = "species")
joined_data[is.na(joined_data)] = 0
total_abundance <- sum(joined_data$abundance, na.rm = TRUE)
joined_data[joined_data$species == "total", "abundance"] <- total_abundance 
joined_data[joined_data$species == "total", "period"] <- most_recent_period

plot_title <- paste0(sp_predictions$forecast_date[2], ": Control plots")
sp_predict <- plot_species_forecast(sp_predictions, title = plot_title)  
sp_predict <- sp_predict + 
              ggplot2::geom_point(data = joined_data, color = "blue", 
                mapping = ggplot2::aes(x = abundance, y = species)) 

plot(sp_predict)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}

# get most recent rodent data
rodents <- portalr::abundance("repo", shape = "flat")
most_recent_period <- max(rodents$period)
observed <- dplyr::filter(rodents, period == most_recent_period)

# get new moon number associated with this period
url_base <- "https://raw.githubusercontent.com/weecology/PortalData/master/"
url_suffix <- "Rodents/moon_dates.csv"
nm_url <- paste(url_base, url_suffix, sep = "")
nm_table <- read.csv(text = RCurl::getURL(nm_url))
nm_table$censusdate <- as.Date(nm_table$censusdate)
moon_code <- dplyr::filter(nm_table, period == most_recent_period) %>% 
             dplyr::select(newmoonnumber) %>% 
             as.integer()
most_recent_date <- dplyr::filter(nm_table, period == most_recent_period) %>%
                    dplyr::pull(censusdate)

# get most recent forecast prior to data collection
file_names <- list.files(path = "./predictions", pattern = "*forecasts.csv")
files <- data.frame(names = file_names)
files$filedates <- as.Date(substr(files$names, 1, 10), format = "%Y-%m-%d")
latest_forecast <- dplyr::filter(files,filedates<most_recent_date) %>% 
                   tail(1)

file_name <- paste("predictions/", latest_forecast$names, sep="")
data <- read.csv(file_name, na.strings = "")

ensemble <- dplyr::filter(data, level == "All", model == "Ensemble", 
              newmoonnumber == moon_code)
ensemble$date <- as.Date(as.character(ensemble$date))
sp_predictions <- get_sp_predicts(ensemble, "All", lead_time = 1)


joined_data <- dplyr::left_join(sp_predictions, observed, by = "species")
joined_data[is.na(joined_data)] = 0
total_abundance <- sum(joined_data$abundance, na.rm = TRUE)
joined_data[joined_data$species == "total", "abundance"] <- total_abundance 
joined_data[joined_data$species == "total", "period"] <- most_recent_period

plot_title <- paste0(sp_predictions$forecast_date[2], ": All plots")
sp_predict <- plot_species_forecast(sp_predictions, title = plot_title)  
sp_predict <- sp_predict + 
              ggplot2::geom_point(data = joined_data, color = "blue", 
                mapping = ggplot2::aes(x = abundance, y = species)) 

plot(sp_predict)
```
