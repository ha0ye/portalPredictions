---
title: "Portal Forecast"
---

Welcome to Portal Forecasting! This is a website run by the 
[Weecology](http://weecology.org/) group, a group of interdisciplinary 
ecologists at the [University of Florida](http://www.wec.ufl.edu/). On this 
website, you'll find information about our ongoing efforts to forecast 
ecological systems from time series. Specifically, we are using a times series 
of rodent abundances from [The Portal project](http://portal.weecology.org/), 
a long-term experimental monitoring project in desert ecology. Enjoy! 

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("tools/forecast_tools.R")
source("tools/data_tools.R")
```

## Total Abundance Forecast

This is the forecast for next month's sampling of rodents at Portal.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
obs_data <- portalr::abundance("repo", level = "treatment", 
              length = "longterm") %>%
            dplyr::filter(treatment == "control")

obs_data$total <- rowSums(dplyr::select(obs_data, -c(period, treatment)))
moon_url_base <- "https://raw.githubusercontent.com/weecology/PortalData/"
moon_url_suffix <- "master/Rodents/moon_dates.csv"
moon_url <- paste(moon_url_base, moon_url_suffix, sep = "")
new_moons <- read.csv(text = RCurl::getURL(moon_url))

join_cols <- c("period" = "period")
obs_data_newmoon <- dplyr::inner_join(obs_data, new_moons, by = join_cols)
obs_data_newmoon$censusdate <- as.Date(obs_data_newmoon$censusdate)

filtering <- quos(level == "Controls", model == "Ensemble", date == max(date))
for_data <- compile_forecasts() %>%
            dplyr::filter(!!!filtering)

most_recent_forecast <- max(for_data$date)
for_data <- dplyr::filter(for_data, date == most_recent_forecast)

for_data$model <- "ensemble"

# get dates for future (and recent not-sampled) new moons for plotting
max_period <- max(obs_data[ , "period"])
max_newmoon <- new_moons$newmoonnumber[which(new_moons$period == max_period)]
future_moons <- get_moon_data() %>% 
                portalr::get_future_moons() 
future_moons$newmoondate <- as.character(future_moons$newmoondate)
total_moons <- rbind(new_moons, future_moons)

which_fcast_moons <- which(total_moons$newmoonnumber > max_newmoon)
fcast_moons <- total_moons[which_fcast_moons, ] %>% 
               dplyr::select(c("newmoonnumber", "newmoondate"))
join_cols <- c("newmoonnumber" = "newmoonnumber")
for_data <- dplyr::inner_join(for_data, fcast_moons, by = join_cols)
for_data$newmoondate <- as.Date(as.character(for_data$newmoondate))

forecast_viz(obs_data = obs_data_newmoon, obs_date_col_name = "censusdate",
  obs_val_col_name = "total", for_data = for_data,
  for_date_col_name = "newmoondate", for_val_col_name = "estimate",
  for_model_name = "ensemble",for_lowerpi_col_name = "LowerPI",
  for_upperpi_col_name = "UpperPI", start_newmoon = 300,
  ylabel = "Total Abundance")
```

## Species-Level Forecasts

```{r speciesforecasts, echo = FALSE, message = FALSE, warning = FALSE}

filtering <- quos(level == "Controls", model == "Ensemble", date == max(date))
ensemble <- compile_forecasts() %>%
            dplyr::filter(!!!filtering)

sp_predictions <- get_sp_predicts(ensemble, "Controls", lead_time = 1)
plot_title <- paste0(sp_predictions$forecast_date[2], ": Control plots")
sp_predict <- plot_species_forecast(sp_predictions, title = plot_title)

plot(sp_predict)

```

## Most Abundant Species

```{r highabund_ts_forecasts, echo = FALSE, message = FALSE, warning = FALSE}

top_n <- 3
most_abund_sp <- sp_predictions %>% 
                 dplyr::filter(species != 'total') %>% 
                 dplyr::arrange(desc(estimate)) %>% 
                 head(top_n) %>% 
                 dplyr::select(species) %>%
                 t() %>% 
                 as.vector()

# load in rodent species table to get scientific names to display on plots

url_base <- "https://raw.githubusercontent.com/weecology/PortalData/"
url_suffix <- "master/Rodents/Portal_rodent_species.csv"
rodent_url <- paste(url_base, url_suffix, sep = "")
spp_txt <- RCurl::getURL(rodent_url)
spp_tbl <- read.csv(text = spp_txt, stringsAsFactors = FALSE, na.strings = "")
most_abund_sp_names <- spp_tbl %>%
                       dplyr::filter(speciescode %in% most_abund_sp) %>% 
                       dplyr::select(speciescode, scientificname)

for (n in 1:top_n){

  species_forecast <- forecast_viz(obs_data = obs_data_newmoon,
                        obs_date_col_name = "censusdate",
                        obs_val_col_name = most_abund_sp_names$speciescode[n],
                        for_data = for_data,
                        for_date_col_name = "newmoondate",
                        for_val_col_name = "estimate",
                        for_model_name = "ensemble",
                        for_lowerpi_col_name = "LowerPI",
                        for_upperpi_col_name = "UpperPI",
                        start_newmoon = 300,
                        ylabel = most_abund_sp_names$scientificname[n])
  plot(species_forecast)
}
```
